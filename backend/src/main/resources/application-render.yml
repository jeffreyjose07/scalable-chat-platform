spring:
  # Render deployment profile - single service with external dependencies
  
  # Lazy initialization for faster startup (20-40% improvement)
  main:
    lazy-initialization: true
    
  # PostgreSQL Configuration (Aiven database)
  datasource:
    url: ${DATABASE_URL}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 3      # Conservative for Render free tier
      minimum-idle: 1
      connection-timeout: 20000
      idle-timeout: 300000
      max-lifetime: 1200000
      # Aiven-specific settings to handle connection pooling
      leak-detection-threshold: 60000
      initialization-fail-timeout: 30000
      auto-commit: false
      # Disable prepared statement cache to avoid pooling issues
      data-source-properties:
        prepareThreshold: 0
        preparedStatementCacheQueries: 0
        preparedStatementCacheSizeMiB: 0
      
  # JPA Configuration
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        # Aiven-specific optimizations
        jdbc:
          time_zone: UTC          # Ensure consistent timezone handling
          batch_size: 15          # Smaller batch size for pooled connections
        connection:
          provider_disables_autocommit: true  # Better transaction management
        order_inserts: true       # Optimize insert operations
        order_updates: true       # Optimize update operations
        # Connection pooling optimizations
        cache:
          use_second_level_cache: false  # Disable L2 cache with connection pooling
          use_query_cache: false         # Disable query cache with pooled connections
        
  # MongoDB Configuration (MongoDB Atlas)
  data:
    mongodb:
      uri: ${MONGODB_URI:mongodb://localhost:27017/chatdb}
      database: chatdb
      auto-index-creation: true
      
  # Redis Configuration (External service - Upstash or similar)
  redis:
    url: ${REDIS_URL:redis://localhost:6379}
    timeout: 2000ms
    ssl: true
    lettuce:
      pool:
        max-active: 3           # Conservative for free tier
        max-idle: 2
        min-idle: 0
        
# Server Configuration
server:
  port: ${PORT:8080}
  compression:
    enabled: true
  tomcat:
    threads:
      max: 50                   # Conservative for free tier
      min-spare: 5
      
  # Static resources configuration for serving React app
  servlet:
    context-path: /
  resources:
    static-locations: classpath:/static/
    cache:
      cachecontrol:
        max-age: 3600           # Cache static files for 1 hour
        must-revalidate: true
    
# WebSocket Configuration
websocket:
  allowed-origins: ${WEBSOCKET_ALLOWED_ORIGINS:*}
  
# Application Configuration with JWT Security
app:
  jwt:
    secret: ${JWT_SECRET:defaultTempSecretChangeInProduction123456789}
    expiration: ${JWT_EXPIRATION:14400000} # 4 hours (matches security implementation)
    issuer: ${JWT_ISSUER:chat-platform-backend}
    audience: ${JWT_AUDIENCE:chat-platform-users}
  
  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS:*}
  
  admin:
    username: ${ADMIN_USERNAME:admin}
    email: ${ADMIN_EMAIL:admin@chatplatform.com}
    password: ${ADMIN_PASSWORD:TempPass123!}
    displayName: ${ADMIN_DISPLAY_NAME:System Administrator}
  
# Logging Configuration (Optimized for Render)
logging:
  level:
    com.chatplatform: INFO
    org.springframework.web: WARN
    org.hibernate.SQL: WARN
    org.hibernate.type: WARN
    org.mongodb: WARN
  pattern:
    console: "%d{HH:mm:ss} %-5level %logger{36} - %msg%n"
    
# Management/Health Check Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info
      base-path: /api/actuator
  endpoint:
    health:
      show-details: when-authorized
      
  
# Render Optimizations
spring.jpa.open-in-view: false
spring.devtools.restart.enabled: false
spring.devtools.livereload.enabled: false

# Resource limits for free tier
spring.datasource.hikari.leak-detection-threshold: 30000

# Single service optimizations  
spring.task.execution.pool.max-size: 4
spring.task.execution.pool.core-size: 2
spring.task.scheduling.pool.size: 2

# Additional startup optimizations
spring.autoconfigure.exclude: |
  org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,
  org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration