# Gemini Instructions

# ⚠️  CRITICAL COMMIT GUIDELINES ⚠️
## NEVER ADD GEMINI AS AUTHOR IN ANY COMMITS
- Never include Gemini as author in commits
- Always use the user's identity for git commits  
- Never add "Co-Authored-By: Gemini" to commit messages
- Never add "Generated with Gemini Code" to commit messages
- Keep commit messages concise and focused
- A git hook will reject commits with Gemini authorship

## Commit Message Format
- **Author:** I will always use the user's identity for git commits.
- **Subject Line:** A concise summary of the changes (e.g., "Refactor user service to improve performance").
- **Body:** A more detailed explanation of the changes, including the "why" behind the changes. I will use bullet points to list individual changes, similar to the existing commits.
- **No "Co-authored-by" or "Generated by":** I will not add any "Co-authored-by" or "Generated by" lines to the commit message.

## Development Preferences
- Follow existing code patterns and conventions
- Run linting and type checking before commits if available
- Only create documentation files when explicitly requested
- Prioritize editing existing files over creating new ones

## Security Guidelines
- Only assist with defensive security tasks
- Never create or improve code that could be used maliciously
- Focus on security analysis, detection rules, vulnerability explanations, and defensive tools

## Build Commands

### Frontend (React)
```bash
cd /Users/jeffrey.jose/cursorProjects/scalable-chat-platform/frontend
npm run build
# NEVER ADD GEMINI AS AUTHOR
```

### Backend (Spring Boot + Gradle)
```bash
export JAVA_HOME=/Users/jeffrey.jose/Library/Java/JavaVirtualMachines/corretto-17.0.15/Contents/Home
cd /Users/jeffrey.jose/cursorProjects/scalable-chat-platform/backend
./gradlew build -x test
# NEVER ADD GEMINI AS AUTHOR
```

### Full Build (Both)
```bash
# Backend builds both frontend and backend automatically
export JAVA_HOME=/Users/jeffrey.jose/Library/Java/JavaVirtualMachines/corretto-17.0.15/Contents/Home
cd /Users/jeffrey.jose/cursorProjects/scalable-chat-platform/backend
./gradlew build -x test
# NEVER ADD GEMINI AS AUTHOR
```

## Common Issues & Fixes

### Java Version Issues
- **Problem**: Build fails with Java 8 vs Spring Boot 3.2.0 requiring Java 17
- **Solution**: Always set `JAVA_HOME=/Users/jeffrey.jose/Library/Java/JavaVirtualMachines/corretto-17.0.15/Contents/Home`

### API URL Double Prefix Issues
- **Problem**: Frontend calls `/api/api/endpoint` instead of `/api/endpoint`
- **Root Cause**: The `api` service in `services/api.ts` already prefixes with `/api`, so don't add `/api` to endpoint URLs
- **Fix**: Use `api.get('/admin/status')` NOT `api.get('/api/admin/status')`

### Token Storage & Authentication Issues
- **Problem**: Login page flashes on refresh, tokens not persisting
- **Root Cause**: Race condition in token initialization or using sessionStorage instead of localStorage
- **Fix**: Use synchronous token initialization and `localStorage` for persistent tokens

### Soft Delete vs Hard Delete Confusion
- **Problem**: Cleanup logic doesn't find "deleted" data
- **Root Cause**: System uses soft deletes (deletedAt timestamp) but cleanup looks for hard deletes
- **Fix**: Use `findAllActiveConversationIds()` (excludes soft-deleted) NOT `findAllConversationIds()` (includes all)

### TypeScript Interface Mismatches
- **Problem**: Frontend TypeScript errors when backend response structure changes
- **Solution**: Always update TypeScript interfaces when adding new fields to backend responses

### Missing Repository Methods
- **Problem**: Calling repository methods that don't exist
- **Solution**: Check existing methods first, add new ones with proper Spring Data naming conventions

### Docker Build Failure (Render)
- **Problem**: `failed to solve: openjdk:17-jdk-slim: not found`
- **Root Cause**: `openjdk` Docker images are deprecated and removed from Docker Hub.
- **Fix**: Use `eclipse-temurin:17-jre` in `Dockerfile` and `Dockerfile.render`.

## Architecture Notes

### Database Setup
- **PostgreSQL**: User data, conversations, participants (JPA/Hibernate)
- **MongoDB**: Chat messages (Spring Data MongoDB)
- **Soft Deletes**: Conversations use `deletedAt` timestamp, not physical deletion

### Authentication Flow
- **JWT tokens** stored in browser localStorage (persistent) or sessionStorage (temporary)
- **Token validation** on every API call via Authorization header
- **Refresh handling** via synchronous token initialization to prevent login page flash

### Cleanup Services
- **AdminDatabaseCleanupService**: Manual admin cleanup via UI
- **DatabaseCleanupService**: Scheduled automatic cleanup every 20 days
- **Three cleanup types**: Orphaned messages, soft-deleted messages, old conversations

### API Structure
- **Base URL**: `/api` prefix automatically added by api service
- **Authentication**: Bearer token in Authorization header
- **Response format**: `{success: boolean, message: string, data: T}`

### Refactoring Changes (Nov 2025)
- **Frontend**: `ChatPage.tsx` split into `ChatSidebar` (navigation/users) and `ChatMainArea` (messages/input).
- **Backend**: `ChatWebSocketHandler` refactored to delegate message processing to `WebSocketMessageDispatcher`.
- **WebSockets**: `DynamicOriginWebSocketConfigurer` enables dynamic origin validation via `WEBSOCKET_ALLOWED_ORIGINS` env var.

## UI Components

### CreateGroupModal Search Implementation
- **Location**: `frontend/src/components/groups/CreateGroupModal.tsx:188-195`
- **Feature**: Real-time search filtering for participants when creating groups
- **Implementation**: Filters users by `displayName` and `email` using case-insensitive matching
- **State Management**: Uses `searchTerm` state with proper cleanup on form reset/cancel

### Password Reset Implementation (Nov 2025)
- **Email Service**: Resend (free tier: 100 emails/day)
- **Token Storage**: Redis with 30-minute expiration
- **Security Features**:
  - Rate limiting (5 requests per hour per email)
  - Single-use tokens (deleted after consumption)
  - Email enumeration prevention (always returns success)
  - Strong password validation (min 8 chars, complexity check)
- **Endpoints**:
  - POST `/api/auth/forgot-password` - Request reset email
  - POST `/api/auth/reset-password` - Reset with token
- **Frontend**: `/reset-password` page with password strength indicator
- **Environment Variables**:
  - `RESEND_API_KEY` - Resend API key (set manually in Render)
  - `RESEND_FROM_EMAIL` - Sender email (default: `onboarding@resend.dev`)
  - `FRONTEND_URL` - Frontend URL for reset links
```