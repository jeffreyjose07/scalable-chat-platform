# Render configuration file for JWT-secured chat platform deployment
services:
  # Combined Web Service (Spring Boot + React) with JWT Security
  - type: web
    name: chat-platform
    env: docker
    dockerfilePath: ./Dockerfile.render
    plan: starter  # Upgraded from free for better performance
    region: oregon
    branch: main
    buildCommand: ""
    startCommand: ""
    healthCheckPath: /api/health/status
    envVars:
      # Application Configuration
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: PORT
        value: 8080
      
      # Java/Gradle Build Optimization
      - key: JAVA_HOME
        value: /usr/local/openjdk-17
      - key: GRADLE_OPTS
        value: "-Xmx2048m -XX:MaxMetaspaceSize=512m -Dorg.gradle.daemon=false"
      - key: JAVA_OPTS
        value: "-Xmx1024m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:TieredStopAtLevel=1 -noverify"
      
      # CORS Configuration - SECURITY HARDENED
      - key: CORS_ALLOWED_ORIGINS
        value: "https://chat-platform.onrender.com"  # Replace with your actual domain
      - key: WEBSOCKET_ALLOWED_ORIGINS
        value: "https://chat-platform.onrender.com"  # Replace with your actual domain
      
      # JWT Security Configuration - PRODUCTION READY
      - key: JWT_SECRET
        sync: false  # CRITICAL: Set manually in Render dashboard with generated secret
      - key: JWT_EXPIRATION
        value: "14400000"  # 4 hours in milliseconds
      - key: JWT_ISSUER
        value: "chat-platform-backend"
      - key: JWT_AUDIENCE
        value: "chat-platform-users"
      
      # Admin Credentials - SET MANUALLY FOR SECURITY
      - key: ADMIN_USERNAME
        value: "admin"
      - key: ADMIN_EMAIL
        value: "admin@chatplatform.com"
      - key: ADMIN_PASSWORD
        sync: false  # CRITICAL: Set manually with strong password
      - key: ADMIN_DISPLAY_NAME
        value: "System Administrator"
      
      # Logging Configuration
      - key: LOGGING_LEVEL_COM_CHATPLATFORM
        value: INFO
      - key: LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB
        value: WARN
      - key: LOGGING_LEVEL_ORG_HIBERNATE
        value: WARN
      - key: LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY
        value: INFO
      
      # External Service URLs (Set these manually in Render dashboard)
      - key: DATABASE_URL
        sync: false  # Neon PostgreSQL connection string
      - key: MONGODB_URI
        sync: false  # MongoDB Atlas connection string
      - key: REDIS_URL
        sync: false  # Redis service connection string (Upstash, Redis Cloud, etc.)
      
      # Email Service Configuration (Resend)
      - key: RESEND_API_KEY
        sync: false  # CRITICAL: Set manually in Render dashboard with your Resend API key
      - key: RESEND_FROM_EMAIL
        value: "onboarding@resend.dev"  # Use Resend's test email (or your custom domain)
      - key: FRONTEND_URL
        value: "https://scalable-chat-platform.onrender.com"  # Replace with your actual frontend URL


# Build System: Migrated from Maven to Gradle for better performance and security
# - Uses Gradle 8.5 with Spring Boot 3.2.0
# - Frontend build integrated via Node.js Gradle plugin
# - Optimized for Render deployment with buildForRender task
#
# Security Notes:
# 1. JWT_SECRET: Generate using: openssl rand -base64 32
# 2. ADMIN_PASSWORD: Use a strong password with mixed case, numbers, symbols
# 3. DATABASE_URL: Set up Neon PostgreSQL and use connection string
# 4. MONGODB_URI: Set up MongoDB Atlas and use connection string
# 5. REDIS_URL: Set up Upstash Redis or Redis Cloud for token blacklisting
# 6. CORS_ALLOWED_ORIGINS: Replace with your actual domain
# 
# Required Manual Environment Variables in Render Dashboard:
# - JWT_SECRET (critical for security)
# - ADMIN_PASSWORD (strong password required)
# - DATABASE_URL (Neon PostgreSQL connection string)
# - MONGODB_URI (MongoDB Atlas connection)
# - REDIS_URL (Redis service for token blacklisting)
#
# Gradle Build Notes:
# - GRADLE_OPTS optimized for containerized builds
# - JAVA_OPTS configured for Render's memory constraints
# - Build uses 'buildForRender' task for optimal JAR creation